# WHAT LURKS BELOW

_Challenge Description: This one seems to be straight forward, but there is no flag to be found! Sample rate = 1024k_


## Initial Thoughts
Immediately after reading the description of the problem, I thought of GPS satellites. The GPS signal is so weak that it is typically below the noise floor of the receivers (What lurks below!), so I'm suspicious that this problem will have a similar theme.

GPS satellites encode their data using a technique called [DSSS](https://en.wikipedia.org/wiki/Direct-sequence_spread_spectrum#:~:text=In%20telecommunications%2C%20direct%2Dsequence%20spread,to%20reduce%20overall%20signal%20interference.&text=With%20DSSS%2C%20the%20message%20bits,known%20as%20a%20spreading%20sequence.). 
The technique involves multiplying each bit by a long sequence of pseudo-random bits before transmission. The receiver can then correlate this seemingly-noise signal with the same sequence and pull it out from below the noise floor


### Getting started

We're given [challenge.cfile](files/challenge.cfile) and nothing else. cfile is a common format for storing complex radio signals - to make it a bit easier to process I quickly passed it through a very simple GNURadio flowgraph to produce a wav file representing the raw input ([challenge.wav](files/challenge.wav))

Looking at this wav file, we can see what appears to be a lot of random noise on both channels, with a small hint of a signal on the I channel:
![raw_challenge_wav](files/images/img1.png)

Armed with the insight that this is probably DSSS, we can **[skip most of the work](QuickSolution.md)**, but that's not how we originally solved it, though I wish it was.  
  <br />


### Decoding the I channel signal  

This is probably a digital radio problem, so I broke out GNURadio to solve it. I start with a frequency sink and constellation sink to see if I can find any pattern to the data:  
![flowgraph 1](files/images/img5.png)
![constellation 1](files/images/img4.png)

_... Nope_

At best I can see perhaps a little bit of data in the <25MHz range, but nothing obvious and definitely no constellation. We'll have to filter some of this noise

![flowgraph 2](files/images/img7.png)
![constellation 2](files/images/img6.png)

After adding my best guess at a relevant filter, we get something much more promising - this looks like a BPSK constellation! That's great news, because BPSK is very easy to decode.

I threw on a Clock Recovery Block to get a an acceptable constellation, and some additional garbage to make it output a string of ones and zeros to a text file. This flowgraph really isn't very good and produces some bit errors, but the sequence repeats several times so I was able to use that as a rudimentary error correction code, and fix the bit errors in a text editor.
![flowgraph 3](files/images/img9.png)
![constellation 3](files/images/img8.png)

The resultant bitstream looks like this:
```
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010101010
00000000000000001001101001101001101001101001010110010101100101101001011010011001101001101010101010010101101001011001010110011010100101101010100110010101101001101001010110011010100101101001100110010110100110101010011010101010100101011001101010010110011010101001011010011001101001101010101010010101100110101001010110100110100101101010100110010110010101101001010110100101100101101001011010010110100110011001010110100110101001101010101010100110011010101001010110100101100101101010100110010110010110011001010110101010100101100101101010010110100110011010011010101010100101011010011010010110101010011001010110011010100101101001100110100110101010101010010101011001101001101010101010100101101010011010010110101010101001011010011010100101100110101001011001100101101001100110100110100110010101101010011010101010100110011001101010010110011010101001011010011001101001101010101010010110101001011001011001101010100101100110100110010101101010101010011010101010100101011010010110010110100110011001010110101001100101011001100110010110100110011001011001010110100101101010010110010110100110011010011010101010100101100110100110010101101001011010010101100110101001101010101010101010011001100110101010101010101010100101101001100101100110101001101010101001010110011001101001101001101001011001010110101010011001010110101010100101011010101001011001011010011001010110011010101010010101101010010110010110010110101010101001101001100110100110100101100110010110100101011001010101100110101010011010100110010110011010010110101010010110101010100110011001010101011010100101101010011010011001010110010110011010101010100110100101100101010101101001010110010110010101011001010110101010010101100101011001011001100110010110011010101001101001011010010101010110100101011010101001101010101010101010011001100110100101100101101010100101010110101001010101100101010110101001101010010110101001101010101001100110010110101010010110101010010101011001101001011010011010011001010101100110011001011001100110101010010110010110010110100101101010010110100110100110100101100101010110011001100101011001100101100101010101010101010110011001101001100110010110010101011001011001011010010101011010100101101001011001011001011010101001100101101010011001100101101010100110011010101010
00000000000000001001101001101001101001101001010110010101100101101001011010011001101001101010101010010101101001011001010110011010100101101010100110010101101001101001010110011010100101101001100110010110100110101010011010101010100101011001101010010110011010101001011010011001101001101010101010010101100110101001010110100110100101101010100110010110010101101001010110100101100101101001011010010110100110011001010110100110101001101010101010100110011010101001010110100101100101101010100110010110010110011001010110101010100101100101101010010110100110011010011010101010100101011010011010010110101010011001010110011010100101101001100110100110101010101010010101011001101001101010101010100101101010011010010110101010101001011010011010100101100110101001011001100101101001100110100110100110010101101010011010101010100110011001101010010110011010101001011010011001101001101010101010010110101001011001011001101010100101100110100110010101101010101010011010101010100101011010010110010110100110011001010110101001100101011001100110010110100110011001011001010110100101101010010110010110100110011010011010101010100101100110100110010101101001011010010101100110101001101010101010101010011001100110101010101010101010100101101001100101100110101001101010101001010110011001101001101001101001011001010110101010011001010110101010100101011010101001011001011010011001010110011010101010010101101010010110010110010110101010101001101001100110100110100101100110010110100101011001010101100110101010011010100110010110011010010110101010010110101010100110011001010101011010100101101010011010011001010110010110011010101010100110100101100101010101101001010110010110010101011001010110101010010101100101011001011001100110010110011010101001101001011010010101010110100101011010101001101010101010101010011001100110100101100101101010100101010110101001010101100101010110101001101010010110101001101010101001100110010110101010010110101010010101011001101001011010011010011001010101100110011001011001100110101010010110010110010110100101101010010110100110100110100101100101010110011001100101011001100101100101010101010101010110011001101001100110010110010101011001011001011010010101011010100101101001011001011001011010101001100101101010011001100101101010100110011010101010
... Repeats a dozen times
```

Note that the data contains a balanced number of ones and zeros - this indicates it's probably manchester-coded. Passing the result through an online manchester decoder produces the following ascii:
```
I've started the transfer (sample rate = 1024k). The chip sequence is: 
ï¿½Â´AÃ”ï¿½pÂ¸8lÂº6Ã€ï¿½ï¿½ÃÃ´"Ã“Ã±ï¿½vï¿½7ÃÃÃ¡ÃÂ«BgÃMï¿½ï¿½xï¿½AXaÃ©ï¿½Ãµjf2MÃªÃ«ÃªVÃ¶ÃÂ¶+
```
The bit after the ascii is 64 bytes:
```
80 0C B4 41 D4 93 70 B8 38 6C BA 0E 36 C0 94 9A CE F4 22 D3 0C 15 F1 89 76 81 37 CE DE E1 DD AB 42 67 CE 10 05 4D 87 8F 78 8C 41 58 61 E9 92 F5 6A 1B 66 32 4D EA EB 7F EA 56 F6 CF 19 B6 16 2B
```

At this point we stalled out a bit. For some reason we forgot the GPS/DSSS insight for about an hour while we tried to pull the flag out of this data. Nothing we did worked, though, and eventually we remembered the name of the challenge and got back on track.

The flag isn't in this sequence. The flag is in the original file, and this is the pseudo-random sequence that was used to encode the data into chips.

If we go back to the original data and correlate it with our newly found chip, we get the following:
![correlated](files/images/img10.png)

There's a positive or negative spike every 512 samples - just as expected! All that's left is to grab each of these bits and convert it to ascii

Matlab script:
```Matlab
[y, Fs] = audioread('challenge.wav');

samples = y(:,2)';

chip = [1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,0,1,1,0,1,0,0,0,1,0,0,0,0,0,1,1,1,0,1,0,1,0,0,1,0,0,1,0,0,1,1,0,1,1,1,0,0,0,0,1,0,1,1,1,0,0,0,0,0,1,1,1,0,0,0,0,1,1,0,1,1,0,0,1,0,1,1,1,0,1,0,0,0,0,0,1,1,1,0,0,0,1,1,0,1,1,0,1,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0,1,0,0,1,1,0,1,0,1,1,0,0,1,1,1,0,1,1,1,1,0,1,0,0,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,1,1,1,1,1,0,0,0,1,1,0,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,0,0,0,0,1,0,0,1,1,0,1,1,1,1,1,0,0,1,1,1,0,1,1,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,1,0,1,1,1,0,1,1,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,0,1,1,0,0,1,1,1,1,1,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,1,1,0,1,1,0,0,0,0,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,1,0,0,0,1,0,0,0,1,1,0,0,0,1,0,0,0,0,0,1,0,1,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,1,0,1,0,0,1,1,0,0,1,0,0,1,0,1,1,1,1,0,1,0,1,0,1,1,0,1,0,1,0,0,0,0,1,1,0,1,1,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,0,0,1,0,0,1,1,0,1,1,1,1,0,1,0,1,0,1,1,1,0,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,0,1,0,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,0,0,1,1,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,1,1,0,0,0,0,1,0,1,1,0,0,0,1,0,1,0,1,1]*2-1;

result = conv(samples,flip(chip));

bits = (sign(result(512:512:end))+1)/2;
```

Plugging the bits from matlab into CyberChef, we get the following output:
```
.PNG
.
...
IHDR.......@.....Ãµ]Â©Â¾...Â·IDATxÃšÃ­ÃÃÂ®Â¢0..P9Ã¡Ã½_Â¹seB..Â».Pt.Â»Ã± Ã”MÃ»Ã‘....Rz.?Ã©O	@........... ......@........... ......@........... .....Â³Â¶Â¼yY.Ã¿^K)e_/Ã™Ã®Ã¨Â·JÃÃ¯Ã¹ÃœÂ¦e_gÃ¯Â©Ã™wiÃ.Â¶Â»Ã«Â·[.e9.Ã…QÃ›kÃcÃ‰>JÃ«]ÂºÂ¯h?.qÃ¬Â½ÃºÃ·Â®Ã•ÃšRÃ”\Ã§Ã˜Ã«4{.+iÃ´YAj:cÃ´Ã¸Â½:Ã¢^.Â·Â¯oÂ·.tÃ‚..Â¡gHÂ½.Ã“ÃºÃ™[Ã«XÃ’.{.Â»Â¦.%Ã­k^.Ã¤..RzÃÃ¶Kc3Âµ'.B3Ã–Ã±Ã¨..ÃÃ°j:jm{Ã¯ÂªÃ£Â¬Ã§Â°y.pÃ•Ã‰Ã«}2Â®hwdz<Ãº*Â¹Â½.Ã¬Âµ%Ã·ÃYÃiÃ©Â´Â·Ã—Ã¹.Â©EÂ¯:.Â¼Â¿w?^_?.:hÃÂ¶;[Ãº..pÂ¹Â¥CnJ.[..Ã½Â»Ã‡:970..S2Ã¸sKÂ¦.u,
.+.=Ã¢"Â¶Ã6.Â¯Â¾.EÃ—y5Ã«ÃÃœÃ”Ã¾sÂ Â¶|ÃÃœÃ¾sÃ­:.)Ã”\EÂ¯.Ã©D.AÃ‹:{o.W,1K.=j.{{..Â¾Ã‹YÂ³Â¦Ã½,vtÂ»h;ÃÂ®ÃOXREÃ›Â¿.Ã“Ã•WÂ·o.Â¡FjÂ³
Ã‚h-Ã—'uÂ¸.;Ã‰Ã.4..3ÃÃ©Â¯Â½Â¿2j68*Ã¼Â¿Â±Â¾5Ã£c.mÃ.NÃˆÃ•Ã­ÃÃ.Ã»Ã¥+\Â¤ÃD..Ã¾Âª.cÃ®Â¯ePÃ¥^.Ã­jvÃ”.Â½Ã.Ã¹"PÃ.Â¨Â£+ÃœÃu.tÂ°.Ã¶Ã·ÃªÂ¼Â¹+bK
{Ã¯oÃ”Â±GÃ.Ã—Ãš.Ã¯5Ã¶ÃÃ„.mOÃ¤Ã¦XtÂ»Â³mÃ.Â¯yÃª0b.\Ã³T"ZÂ¯Â«.ÃÃ™w.ÃÃª8Ãª.hÃ¯c..	,Ã©As,SBuÃ”7ÃºÃ–Ã€..Ã¢..}.eÃ”7xÃ”..j.sÃ°}fY.ÃŒ..U_Ã¤JF.Ã¼,K........ ......@........... ......@........... ......@..Ã£Ã¼..CjPzÃ±Â¿Â¾....IENDÂ®B`..
```

Saving as a PNG, we get the flag!

![flag](files/images/lurk.png)